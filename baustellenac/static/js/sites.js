// Generated by CoffeeScript 1.4.0

$.fn.sites = function(opts) {
  var cloudmate_api_key, create_infomodal, icon, init, make_infopopup, make_marker, make_route, map, map_attribution, map_url, map_zoom, markers, max_zoom, show_infomodal;
  if (opts == null) {
    opts = {};
  }
  map_zoom = 13;
  max_zoom = 18;
  map = L.map('map').setView([50.7753455, 6.0838868], map_zoom);
  markers = {};
  icon = L.icon({
    iconUrl: '/static/img/Under_construction_icon-red.svg',
    iconSize: [38, 95],
    iconAnchor: [22, 94],
    popupAnchor: [-3, -76],
    shadowSize: [68, 95],
    shadowAnchor: [22, 94]
  });
  cloudmate_api_key = 'f21ddba0627f45a7820c966a23ca9002';
  map_url = 'http://{s}.tile.cloudmade.com/' + cloudmate_api_key + '/997/256/{z}/{x}/{y}.png';
  map_attribution = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>';
  init = function() {
    L.tileLayer(map_url, {
      attribution: map_attribution,
      maxZoom: max_zoom
    }).addTo(map);
    $('.site').each(function() {
      return make_marker($(this));
    });
    $('.site').click(function() {
      return markers[$(this).data('id')].openPopup();
    });
    return map.on('popupopen', function() {
      return $('.moreinfo').click(function(e) {
        return show_infomodal($(this).data('id'));
      });
    });
  };
  show_infomodal = function(sid) {
    var path;
    path = '/api/site/' + sid + '.json';
    return $.ajax({
      url: path,
      dataType: 'json',
      success: function(data) {
        console.log(data);
        create_infomodal(data);
        return $('#infomodal').modal('show');
      },
      error: function() {
        return alert("Error");
      }
    });
  };
  create_infomodal = function(data) {
    var approx_time, body, desc, m, organisation;
    m = $('#infomodal');
    m.find('.modal-header h3').html(data['name']);
    body = "";
    desc = $('<div class="row"></div>').append('<div class="span2">Bescreibung</div>').append('<div class="span4">' + data['description'] + '</div>');
    organisation = $('<div class="row"></div>').append('<div class="span2">Träger</div>').append('<div class="span4">' + data['organisation'] + '</div>');
    approx_time = $('<div class="row"></div>').append('<div class="span2">Vorr. Zeitrahmen</div>').append('<div class="span4">' + data['approx_timeframe'] + '</div>');
    m.find('.modal-body').html('');
    m.find('.modal-body').append(desc);
    m.find('.modal-body').append(organisation);
    m.find('.modal-body').append(approx_time);
    return console.log(desc);
  };
  make_marker = function(elem) {
    var end_lat, end_lng, start_lat, start_lng, start_marker;
    start_lat = elem.data('start_lat');
    start_lng = elem.data('start_lng');
    end_lat = elem.data('end_lat');
    end_lng = elem.data('end_lng');
    start_marker = L.marker([start_lat, start_lng], {
      icon: icon
    }).addTo(map);
    markers[elem.data('id')] = start_marker;
    return start_marker.bindPopup(make_infopopup(elem));
  };
  make_infopopup = function(elem) {
    var info;
    info = '<b>' + elem.data('name') + '</b><br/><br/>';
    info += elem.data('description') + '<br/><br/>';
    info += 'Träger: ' + elem.data('organisation') + '<br/><br/>';
    info += 'Vorr. Dauer: ' + elem.data('approx_timeframe') + '<br/><br/>';
    info += '<button class="moreinfo" type="button" data-id="' + elem.data('id') + '">Mehr Informationen</button>';
    return info;
  };
  make_route = function(start_lat, start_lng, end_lat, end_lng) {
    var routing_url;
    routing_url = "http://routes.cloudmade.com/f21ddba0627f45a7820c966a23ca9002/api/0.3/" + start_lat + "," + start_lng + "," + end_lat + "," + end_lng + "/foot.js?lang=de&units=km";
    return $.ajax({
      url: routing_url,
      dataType: 'jsonp',
      success: function(data) {
        var polyline;
        if (data['status'] === 0) {
          return polyline = L.polyline(data.route_geometry, {
            color: 'red'
          }).addTo(map);
        }
      },
      error: function() {
        return alert("Error");
      }
    });
  };
  $(this).each(init);
  return this;
};

$(document).ready(function() {
  return $("body").sites();
});
